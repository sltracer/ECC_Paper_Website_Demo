<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Ternary Error Correction Code</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <style>
        /* ==================== 全局样式 ==================== */
        body {
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
        font-family: sans-serif;
        line-height: 1.6;
        color: #333;
        }

        /* ==================== 布局样式 ==================== */
        .page-container {
        display: flex;
        align-items: flex-start;
        gap: 20px;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        }

        /* ==================== 标题和文本样式 ==================== */
        .paper-title {
        text-align: center;
        font-size: 2em;
        color: #2c3e50;
        margin: 0 0 20px;
        font-weight: 600;
        letter-spacing: -0.5px;
        }

        .authors {
        text-align: center;
        margin-bottom: 20px;
        font-size: 1.1em;
        color: #7f8c8d;
        }

        .author {
        display: inline-block;
        margin: 0 10px;
        }

        .separator {
        color: #bdc3c7;
        font-weight: 300;
        }

        h1 { font-size: 1.6em; margin-bottom: 20px; }
        h2 { font-size: 1.3em; margin: 1em 0 0.5em; }
        h3 { font-size: 1.1em; margin: 1em 0 0.5em; }
        sub { vertical-align: baseline; font-size: 0.8em; }

        /* ==================== 功能模块样式 ==================== */
        /* 主内容区 */
        .d4-section {
        flex: 1;
        margin: 20px 0;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 6px;
        }

        /* 折叠面板 */
        details.operation-section {
        border: 2px solid #ddd;
        border-radius: 6px;
        padding: 10px;
        margin: 20px 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        details.operation-section summary {
        cursor: pointer;
        padding: 10px 10px 10px 28px;
        list-style: none;
        position: relative;
        }


        details.operation-section summary::before {
                content: "▶";
                position: absolute;
                left: 10px;
                top: 50%;
                transform: translateY(-50%);
                color: #0033ff;
                }

        details.operation-section[open] summary::before {
                content: "▼";
                }    


        /* 编码/解码区块 */
        .encode-section,
        .decode-section {
        margin-top: 20px;
        padding: 15px;
        background: #f8f8f8;
        border-radius: 4px;
        border: 1px solid #eee;
        }

        .input-instructions {
        font-size: 0.9em;
        color: #666;
        margin: 8px 0 16px;
        }

        /* ==================== 表格样式 ==================== */
        .analysis-table {
        margin: 20px 0;
        }

        .analysis-table table {
        border-collapse: collapse;
        width: 100%;
        margin: 15px auto;
        }

        .analysis-table th,
        .analysis-table td {
        border: 1px solid #000;
        padding: 8px;
        text-align: center;
        vertical-align: middle;
        }

        .analysis-table caption {
        font-weight: bold;
        margin-bottom: 10px;
        }

        .clickable-case {
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 80px;
        }

        .clickable-case:hover {
        background-color: rgba(0, 51, 255, 0.08);
        }

        .clickable-case.active {
        background-color: rgba(0, 51, 255, 0.15);
        box-shadow: inset 0 0 0 2px #0033ff;
        }

        /* ==================== 侧边面板样式 ==================== */
        /* 通用面板样式 */
        .qa-panel,
        .definition-panel {
        position: fixed;
        top: 0;
        right: -350px;
        width: 260px;
        height: 100vh;
        background: white;
        box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        transition: right 0.3s ease;
        z-index: 1000;
        padding: 20px;
        overflow-y: auto;
        }

        .qa-panel.active,
        .definition-panel.active {
        right: 0;
        }

        /* 内容区域 */
        .qa-content,
        .definition-content {
        padding-top: 20px;
        }

        .qa-item,
        .definition-item {
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
        }

        .qa-question,
        .definition-term {
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 5px;
        }

        .qa-answer,
        .definition-description {
        color: #7f8c8d;
        font-size: 0.9em;
        line-height: 1.5;
        }

        /* 切换按钮 */
        .qa-toggle,
        .definition-toggle {
        cursor: pointer;
        padding: 6px 12px;
        background: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        transition: all 0.3s;
        }

        .qa-toggle:hover,
        .definition-toggle:hover {
        background: #e0e0e0;
        }

        /* ==================== 数学公式样式 ==================== */
        .latex-style {
        font-family: "Cambria Math", "Latin Modern Math", serif;
        font-size: 1.1em;
        color: #333;
        }

        .frac {
        display: inline-block;
        position: relative;
        text-align: center;
        vertical-align: middle;
        margin: 0 0.2em;
        }

        .numerator {
        display: block;
        padding: 0 0.5em;
        border-bottom: 1px solid;
        }

        .denominator {
        display: block;
        padding: 0 0.5em;
        }

        .latex-var {
        font-style: italic;
        padding-right: 0.3em;
        }

        /* ==================== 状态和提示样式 ==================== */
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }

        .status-message { color: #333; }
        .status-content.error { color: red; }
        .status-content.warning { color: orange; }
        .status-content.success { color: green; }

        .highlight-box {
        display: inline-block;
        padding: 2px 6px;
        border: 2px solid #2c7be5;
        border-radius: 4px;
        margin: 0 2px;
        background: #f8f9fe;
        }

        /* ==================== 页脚样式 ==================== */
        .site-footer {
        margin-top: 50px;
        padding: 30px 0;
        border-top: 1px solid #eaeaea;
        background-color: #f9f9f9;
        }

        .footer-links {
        max-width: 800px;
        margin: 0 auto;
        text-align: center;
        display: flex;
        justify-content: center;
        gap: 30px;
        }

        .footer-links a {
        color: #2c3e50;
        text-decoration: none;
        font-size: 0.95em;
        transition: color 0.3s ease;
        }

        .footer-links a:hover {
        color: #3498db;
        text-decoration: underline;
        }

        /* ==================== 响应式设计 ==================== */
        @media (max-width: 600px) {
        .page-container {
            flex-direction: column;
        }
        
        .footer-links {
            flex-direction: column;
            gap: 15px;
        }
        
        .qa-panel,
        .definition-panel {
            width: 80%;
            right: -100%;
        }
        }

        /* Light red background for highlighting */
        .clickable-case.highlighted {
        background-color: #fdd;
        }


        .paper-header {
            text-align: center; /* 整体内容居中 */
        }

        .authors-container {
            position: relative; /* 为绝对定位按钮提供参考 */
            display: flex;
            justify-content: center; /* 作者信息居中 */
            margin-top: 10px; /* 根据实际需要调整与标题的间距 */
        }

        .title-wrapper {
            position: relative;
            text-align: center;      /* 标题居中 */
            }

        .paper-title {
        margin: 0;
        }

        .language-link {
        position: absolute;
        top: 0;
        right: 0;
        }

        .language-btn {
        position: absolute;           /* 绝对定位 */
        top: 0;                       /* 顶部对齐 */
        right: 0;                     /* 右边对齐 */
        padding: 6px 12px;
        font-size: 16px;              /* 使用更大字体（你原来优先级较高） */
        background: #f4f4f4;
        border: 2px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
        }

        .engine-btn {
        position: absolute;           /* 绝对定位 */
        top: 32px;                       /* 顶部对齐 */
        left: 16px;                     /* 右边对齐 */
        padding: 6px 12px;
        font-size: 16px;              /* 使用更大字体（你原来优先级较高） */
        background: #f4f4f4;
        border: 2px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
        }

        #loading-panel {
            position: fixed;
            top: 80px;
            left: 10px;
            width: 220px;
            padding: 15px;
            background: #f5f5f5;
            border: 2px solid #ccc;
            border-radius: 8px;
            box-shadow: 2px 2px 6px rgba(0,0,0,0.1);
            z-index: 999;
            font-size: 14px;
            color: #333;
            transition: left 0.5s ease, opacity 0.5s ease;
            }

        #loading-panel.hidden {
            opacity: 0;
            pointer-events: none;
            left: -250px;
        }

        #loading-log {
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <button id="toggle-loading-panel-btn" class="engine-btn" style="margin-right: 10px;">Engine Log</button>
    <!-- ==================== 论文标题和作者 ==================== -->
    <div class="paper-header">
        <div class="title-wrapper">

          <h1 class="paper-title">Ternary Error Correction Codes</h1>

          <a href="index_SEC_TED_cn.html" class="language-link">
            <button class="language-btn">Language: English</button>
          </a>

        </div>
      </div>
        <div class="authors-container"> <!-- 新增容器包裹作者和按钮 -->
            <div class="authors">
                <span class="author">Jiaxu Hu</span>
                <span class="separator">·</span>
                <span class="author">Kenneth J. Roche</span>
            </div>
        </div>
    <!-- ==================== D4 固定面板 ==================== -->
    <div class="d4-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; gap: 10px;">
            <h1 style="flex-grow: 1;">SEC-TED Version(Minumum Distance 4)</h1>
            <div style="display: flex; gap: 5px;">
                <button id="definitionToggleBtn" class="definition-toggle" onclick="toggleDefinition()">Definition ▼</button>
                <button id="qaToggleBtn" class="qa-toggle" onclick="toggleQA()">FAQ ▼</button>
            </div>
        </div>
        <div>
            This version can <strong>correct a single error</strong> (SEC) iff 
            there is <b>exactly one</b> erroneous trit(which means it has a wrong value) in the codeword; 
            and it can <strong>detect</strong> the presence of errors as long as there are <b>no more than three</b> erroneous trits (TED).
            For a more detailed explanation, please refer to   
            <a href="#" onclick="toggleQA(); return false;">FAQ</a> 
            and <strong>section 4.2</strong>
            of <a href="https://placeholderhere" target="_blank" rel="noopener noreferrer">the paper</a>.
        </div>        

        <!-- 编码部分 -->
        <div class="encode-section">
            <h2>Encode D4</h2>
            <div class="input-instructions">
                Sample: "02110010221011221"  
                <button onclick="d4_encoding_generate_Random_Ternary()" style="margin-left: 10px;">Random Message</button>
            </div>
            <div><strong>Ternary Message</strong></div>
            <input type="text" id="d4_inputMessage" placeholder="Minimum Length: 3" style="flex-grow: 1;">
            <button onclick="D4_construct_runEncode()">Encode</button>
            <button onclick="document.getElementById('d4_inputMessage').value = ''">Clear</button>


            <div id="d4_encode_Output"></div>
        </div>

        <!-- 解码部分 -->
        <div class="decode-section">
            <h2>Decode D4</h2>
            <div class="input-instructions">
                Sample: "2020211001022210112220"
            </div>
            <div><strong>D4 Code</strong></div>
            <input type="text" id="d4_inputCode" placeholder="Minimum Length: 8">
            <button onclick="D4_EC_runDecode()">Decode</button>
            <button onclick="document.getElementById('d4_inputCode').value = ''">Clear</button>
            <div id="d4_decode_output"></div>
        </div>


        <div id="qaPanel" class="qa-panel">
            <div id="qaContent" class="qa-content">
                <h3 style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Frequently Asked Questions</span>
                    <button class="close-btn" onclick="toggleQA()">X</button>
                  </h3>

                <div class="qa-item">
                    <div class="qa-question">Q1: What does Encode D4 do?</div>
                    <div class="qa-answer">A1: Type any ternary message with at least 3 places and click on "Encode", it will generate a error correction code for you.</div>
                </div>
                <div class="qa-item">
                    <div class="qa-question">Q2: What does Decode D4 do?</div>
                    <div class="qa-answer">
                        A1: Type an <strong style="color: black;">error correction code</strong> (the one you get from Encode D4), with some errors, and click on "Decode":
                        <ul style="margin-top: 8px; margin-bottom: 8px; padding-left: 20px;">
                          <li><strong>0 errors:</strong> Will detect it's a perfect code and show the original message</li>
                          <li><strong>1 error:</strong> Will automatically correct it and show the original message</li>
                          <li><strong>2 errors:</strong> Will detect exactly 2 errors and warn you (but cannot correct)</li>
                          <li><strong>3 errors:</strong> May detect error exist, but incorrectly identify as 1-error case (false correction)</li>
                          <li><strong>4+ errors:</strong> Beyond the correction capability of this code</li>
                        </ul>
                        The code can reliably detect up to 3 errors and correct 1 error.
                      </div>                
                </div>

                <!-- 更多Q&A项... -->
            </div>
        </div>

        <div id="definitionPanel" class="definition-panel">
            <div id="definitionContent" class="definition-content">
                <h3 style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Key Definitions</span>
                    <button class="close-btn" onclick="toggleDefinition()">X</button>
                  </h3>

                <!-- 定义1：Error Correction Code -->
                <div class="definition-item">
                    <div class="definition-term"><strong>Error Correction Code</strong></div>
                    <div class="definition-description">
                        A system of adding redundant data (the cost) to a message that enables detection and correction 
                        of errors during transmission or storage.
                    </div>
                </div>
        
                <!-- 定义2：Efficiency -->
                <div class="definition-item">
                    <div class="definition-term"><strong>Code Rate</strong></div>
                    <div class="definition-description">
                        The ratio of length between original message and encoded message. Calculated as:<br>
                        <div class="latex-style">
                            <span class="latex-var">Code Rate</span> = 
                            <span class="frac">
                              <span class="numerator">message length</span>
                              <span class="denominator">encoded length</span>
                            </span>
                          </div>
                          
                        Higher code rate indicate less cost for the error correction.
                    </div>
                </div>
        
                <!-- 定义3：Hamming Distances -->
                <div class="definition-item">
                    <div class="definition-term"><strong>Minumum Hamming Distances</strong></div>
                    <div class="definition-description">
                        For error correction code, it is the minimum number of positions in which any two distinct valid codewords(with same length) differ.<br>
                        <strong>D3:</strong> Distance=3 (SEC-DED, Single Error Correction and Double Error Detection)<br>
                        <strong>D4:</strong> Distance=4 (SEC-TED, Single Error Correction and Triple Error Detection)
                    </div>
                </div>
            </div>
        </div>

            <!-- 加载状态 -->
            <div id="loading-panel">
                <h3 style="margin-top: 0;">Engine Log</h3>
                <div id="loading-log">Starting...</div>
            </div>

    </div>

    <!-- ==================== D3 折叠面板 ==================== -->
    <details class="operation-section">
        <summary><h1>SEC-DED Version(With Higher Information Rate)</h1></summary>
        <div>
            
            <div>
                This version can <strong>correct a single error</strong> (SEC) iff 
                there is <b>exactly one</b> erroneous trit in the codeword; 
                and it can <strong>detect</strong> the presence of errors as long as there are <b>no more than two</b> erroneous trits (DED).
                For a more detailed explanation, please refer to <strong>section 4.1</strong>
                of <a href="https://placeholderhere" target="_blank" rel="noopener noreferrer">the paper</a>.
            </div>        
        <!-- 编码部分 -->
        <div class="encode-section">
            <h2>Encode D3</h2>
            <div class="input-instructions">
                Sample: "2100212002202121021010202201111101121"
                <button onclick="d3_encoding_generate_Random_Ternary()" style="margin-left: 10px;">Random Message</button>
            </div>
            <div><strong>Ternary Message</strong></div>
            <input type="text" id="inputMessage" placeholder="Minimum Length: 2">
            <button onclick="D3_construct_runEncode()">Encode</button>
            <button onclick="document.getElementById('inputMessage').value = ''">Clear</button>
            <div id="encodeOutput"></div>
        </div>

        <!-- 解码部分 -->
        <div class="decode-section">
            <h2>Decode D3</h2>
            <div class="input-instructions">
                Sample: "222100021200202021210210102022011111011221"
            </div>
            <div><strong>D3 Code</strong></div>
            <input type="text" id="inputCode" placeholder="Minimum Length: 4">
            <button onclick="D3_EC_runDecode()">Decode</button>
            <button onclick="document.getElementById('inputCode').value = ''">Clear</button>
            <div id="output"></div>
        </div>
    </details>

    <footer class="site-footer">
        


        <div class="footer-links">
            <a href="Jiaxu_Hu_Resume_April_1st.pdf" target="_blank" rel="noopener">Resume</a>
            <a href="https://github.com/justaplaceholderhere" target="_blank" rel="noopener">GitHub</a>
            <a href="https://faculty.washington.edu/k8r/" target="_blank" rel="noopener">Website</a>
        </div>
    </footer>


    <script>
        let pyodide;
        let pyodideReady = false;

        function logLoading(message) {
            const logDiv = document.getElementById("loading-log");
            if (logDiv) {
                logDiv.innerHTML += `<div>• ${message}</div>`;
                logDiv.scrollTop = logDiv.scrollHeight;  // 自动滚动到底部
            }
        }

        async function initializePyodide() {
            logLoading("Loading Pyodide...");
            pyodide = await loadPyodide({
                indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/"
            });
            
            // 0. 显式加载numpy包
            logLoading("Loading numpy...");
            await pyodide.loadPackage("numpy");  // 确保使用await等待加载完成

            // 1. 创建虚拟文件系统
            logLoading("Setting up virtual FS...");
            await pyodide.FS.mkdir('/mypkg');
            await pyodide.FS.mount(pyodide.FS.filesystems.IDBFS, { root: '.' }, '/mypkg');

            // 2. 动态加载Python文件并写入虚拟目录
            logLoading("Loading Python modules...");
            const files = ['Module.py', 'Web_Final_D3.py', 'Web_Final_D3_EC.py', 'Web_Final_D4.py', 'Web_Final_D4_EC.py'];
            for (const file of files) {
                const response = await fetch(file);
                const content = await response.text();
                pyodide.FS.writeFile(`/mypkg/${file}`, content, { encoding: 'utf8' });
            }

            // 3. 添加路径并导入模块
            logLoading("Finalizing setup...");
            await pyodide.runPython(`
                import sys
                sys.path.append('/mypkg')
                from Web_Final_D3_EC import main_function
            `);

            pyodideReady = true;
            logLoading("<span style='color:green;'>✅ All modules loaded successfully!</span>");
            const logDiv = document.getElementById("loading-log");
            if (logDiv) {
                logDiv.innerHTML += `<h3 style="margin-top: 0; font-size: 20px; font-family: sans-serif;">History</h3>`;
            }

            // 隐藏浮窗
            setTimeout(() => {
            const panel = document.getElementById("loading-panel");
            if (panel) {
                panel.classList.add("hidden");
            }
            }, 2000);
        }
        
        function validateInput(input,minlength) {
            // 检查输入长度
            if (input.length < minlength) {
                alert(`At least ${minlength} trits please, currently ${input.length} trits.`);
                return false;
            }
            // 使用正则表达式校验合法性
            if (!/^[012]+$/.test(input)) {
                alert("Your input must be ternary!");
                return false;
            }
            return true;
        }

        async function D4_construct_runEncode() {
            const input = document.getElementById('d4_inputMessage').value;
            const outputDiv = document.getElementById('d4_encode_Output');
            logLoading(`D4 Encode: '<span style="color:blue;">${input}</span>'`);
            // 新增校验逻辑
            if (!validateInput(input,3)) {
                outputDiv.innerHTML = '<div class="error">Please check the format of your input.</div>';
                return; // 校验失败时终止执行
            }

            outputDiv.innerHTML = "D4 Encoding...";
            
            try {
                const resultProxy  = await pyodide.runPython(`
                    from Web_Final_D4 import main_function
                    correct_code, code_length, efficiency = main_function("${input}")
                    [correct_code, code_length, efficiency]
                `);
                const result = Array.from(resultProxy);
                console.log("Result:", result); //如果需要印出来就用logloading啥的

                outputDiv.innerHTML = `
                    Result:<span class="success"> Success!</span>
                    <div>
                        D4 Correct Codeword: "<span>${result[0]}</span>"
                        <button type="button"
                            onclick="setD4DecodeInput('${result[0]}')">
                            As Input for Decode
                        </button>
                    </div>
                    <div>Length: ${result[1]}</div>
                    <div>Code Rate: ${result[2]}</div>
                `;
            } catch (error) {
                console.error("JavaScript捕获的错误:", error);
                outputDiv.innerHTML = `<div class="error">错误: ${error.message}</div>`;
            }
        }

        async function D4_EC_runDecode() {

            // 在解码开始前获取当前折叠状态
            const errorCaseDetails = document.getElementById('ErrorCaseAnalysis');
            const wasOpen = errorCaseDetails ? errorCaseDetails.open : false;

            const input = document.getElementById('d4_inputCode').value;
            const outputDiv = document.getElementById('d4_decode_output');

            logLoading(`D4 Decode: '<span style="color:blue;">${input}</span>'`);

            if (!validateInput(input, 8)) {
                outputDiv.innerHTML = '<div class="error">Please check the format of your input.</div>';
                return;
            }

            outputDiv.innerHTML = "D4 Decoding...";

            try {
                const resultProxy  = await pyodide.runPython(`
                    from Web_Final_D4_EC import main_function
                    correct_code, pure_message, error_location, announcement, P_all, P_1, P_2, P_all_case, I = main_function("${input}")
                    [correct_code, pure_message, error_location, announcement, P_all, P_1, P_2, P_all_case, I]
                `);
                const result = Array.from(resultProxy);
                const statusText = result[3];
                const refine_result = [...result];
                let statusClass = '';

                if (statusText.includes("two or more mistakes")) {
                    statusClass = "error";
                    refine_result[0] = 'N/A';
                    refine_result[1] = 'N/A';
                    refine_result[2] = 'N/A';
                } else if (statusText.includes("error is located at")) {
                    statusClass = "warning";
                    refine_result[0] = highlightDifferences(input, result[0])
                } else if (statusText.includes("perfect code")) {
                    statusClass = "success";
                    refine_result[2] = 'N/A';
                }

                outputDiv.innerHTML = `
                    <div class="status-message">
                        Status: <span class="status-content ${statusClass}">${statusText}</span>
                    </div>
                    <div>Correct Codeword: "${refine_result[0]}"</div>
                    <div>Original Message: "${refine_result[1]}"</div>

                <details id="ErrorCaseAnalysis" ${wasOpen ? 'open' : ''}>
                <summary>Error Case Analysis</summary>

                <div>Index of Erroneous Trit: ${refine_result[2]}</div>
                <div>P_all: ${refine_result[4]}</div>
                <div>P_1: ${refine_result[5]}</div>
                <div>P_2: ${refine_result[6]}</div>

                <div class="analysis-table" style="margin-top: 10px;">
                    <table class="interactive-table" style="border-collapse: collapse; margin: 1em auto;">
                    <caption>Error Case Analysis</caption>
                    <thead>
                        <tr>
                        <th style="border: 1px solid #000; padding: 6px;"></th>
                        <th style="border: 1px solid #000; padding: 6px;">A: P<sub>all</sub>=0</th>
                        <th style="border: 1px solid #000; padding: 6px;">B: P<sub>all</sub> ∈ I ∨ 2P<sub>all</sub> ∈ I</th>
                        <th style="border: 1px solid #000; padding: 6px;">C: P<sub>all</sub>,2P<sub>all</sub> ∉ I ∪ {0}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Row 1 -->
                        <tr>
                        <td style="border: 1px solid #000; padding: 6px;">
                            1: P<sub>1</sub>=0, P<sub>2</sub>=0
                        </td>
                        <td id="cell-r1c1" class="clickable-case"
                            data-example="2020211001022210112220"
                            style="border: 1px solid #000; padding: 6px;">
                            Perfect
                        </td>
                        <td id="cell-r1c2" class="clickable-case"

                            data-example="2<span style='color:red;'>2</span>2021100102221011222<span style='color:red;'>1</span>"
                            style="border: 1px solid #000; padding: 6px;">
                            2 Errors
                        </td>
                        <!-- C: separate cell for row 1 -->
                        <td id="cell-r1c3" class="clickable-case" 

                            data-example="<span style='color:red;'>1</span>0<span style='color:red;'>0</span>0211001022210112220"
                            style="border: 1px solid #000; padding: 6px;">
                            2 Errors
                        </td>
                        </tr>
                        
                        <!-- Row 2 -->
                        <tr>
                        <td style="border: 1px solid #000; padding: 6px;">
                            2: P<sub>1</sub>=0, P<sub>2</sub>≠0
                        </td>
                        <td id="cell-r2c1" class="clickable-case"
                            data-example="202021100102221011222<span style='color:red;'>1</span>"
                            style="border: 1px solid #000; padding: 6px;">
                            X<sub>Ē</sub> = X<sub>E</sub> - P<sub>2</sub>
                        </td>
                        <td id="cell-r2c2"  class="clickable-case"
                            data-example="2<span style='color:red;'>1</span>20211001022210112220"
                            style="border: 1px solid #000; padding: 6px;">
                            Complex Case 1
                        </td>
                        <!-- C: separate cell for row 2 -->
                        <td id="cell-r2c3" class="clickable-case"
                            data-example="2<span style='color:red;'>1</span>202<span style='color:red;'>2</span>1001022210112220"
                            style="border: 1px solid #000; padding: 6px;">
                            2 Errors
                        </td>
                        </tr>
                        
                        <!-- Row 3 -->
                        <tr>
                        <td style="border: 1px solid #000; padding: 6px;">
                            3: P<sub>1</sub>≠0, P<sub>2</sub>=0
                        </td>
                        <td id="cell-r3c1" class="clickable-case"
                            data-example="20202110010222101122<span style='color:red;'>1</span>0"
                            style="border: 1px solid #000; padding: 6px;">
                            X<sub>Ō</sub> = X<sub>O</sub> - P<sub>1</sub>
                        </td>
                        <td id="cell-r3c2" class="clickable-case"
                            data-example="<span style='color:red;'>1</span>020211001022210112220"
                            style="border: 1px solid #000; padding: 6px;">
                            Complex Case 2
                        </td>
                        <!-- C: separate cell for row 3 -->
                        <td id="cell-r3c3" class="clickable-case"
                            data-example="<span style='color:red;'>1</span>0<span style='color:red;'>1</span>0211001022210112220"
                            style="border: 1px solid #000; padding: 6px;">
                            2 Errors
                        </td>
                        </tr>
                        
                        <!-- Row 4 -->
                        <tr>
                        <td style="border: 1px solid #000; padding: 6px;">
                            4: P<sub>1</sub>≠0, P<sub>2</sub>≠0
                        </td>
                        <td id="cell-r4c1" class="clickable-case"
                            data-example="<span style='color:red;'>01</span>20211001022210112220"
                            style="border: 1px solid #000; padding: 6px;">
                            2 Errors
                        </td>
                        <td id="cell-r4c2" class="clickable-case"
                            data-example="<span style='color:red;'>02</span>20211001022210112220"
                            style="border: 1px solid #000; padding: 6px;">
                            2 Errors
                        </td>
                        <!-- C: separate cell for row 4 -->
                        <td id="cell-r4c3" class="clickable-case"
                            data-example="2<span style='color:red;'>10</span>0211001022210112220"
                            style="border: 1px solid #000; padding: 6px;">
                            2 Errors
                        </td>
                        </tr>
                    </tbody>
                    </table>

                <!-- 修改表格下方显示容器 -->
                <div id="caseExample" class="example-container" style="margin-top:10px; text-align:center; font-weight:bold;">
                    <span class="placeholder-text">Click any case to show a sample code</span>
                </div>

                    <!-- Case 1 and Case 2 explanations -->
                    <div class="case-explanations" style="margin-top: 20px; padding: 15px; border-top: 2px solid #eee;">
                        <h4>Case Analysis</h4>

                        <p><strong>Complex Case 1:</strong> Define <em>f</em> = P<sub>2</sub> · P<sub>all</sub></p>

                        <ul style="list-style-type: circle; padding-left: 20px;">

                            <li>
                                If <em>f</em> ∈ I<sub>2</sub>, it implies there is a single error at <em>f</em>, with original value: X̄<sub>f</sub> = (X<sub>f</sub> - P<sub>2</sub>) mod 3.
                                <br>Sample: "2<span style='color:red;'>1</span>20211001022210112220" 
                                <button type="button"
                                        onclick="setD4DecodeInput('2120211001022210112220')">
                                    As Input for Decode
                                </button>
                            </li>

                            <li>
                                If <em>f</em> ∉ I<sub>2</sub>, it implies there are at least three erroneous trits in the code.
                                <br>Sample: "2<span style='color:red;'>2</span>202110010222101<span style='color:red;'>20</span>220" 
                                <button type="button"
                                        onclick="setD4DecodeInput('2220211001022210120220')">
                                    As Input for Decode
                                </button>
                            </li>

                        </ul>

                        <p><strong>Complex Case 2:</strong> Define <em>f</em> = P<sub>1</sub> · P<sub>all</sub></p>

                        <ul style="list-style-type: circle; padding-left: 20px;">

                            <li>
                                If <em>f</em> ∈ I<sub>1</sub>, it implies there is a single error at <em>f</em>, with original value: X̄<sub>f</sub> = (X<sub>f</sub> - P<sub>1</sub>) mod 3.
                                <br>Sample: "<span style='color:red;'>1</span>020211001022210112220"
                                <button type="button"
                                        onclick="setD4DecodeInput('1020211001022210112220')">
                                    As Input for Decode
                                </button>
                            </li>

                            <li>
                                If <em>f</em> ∉ I<sub>1</sub>, it implies there are at least three erroneous trits in the code.
                                <br>Sample: "<span style='color:red;'>1</span>0202110010<span style='color:red;'>00</span>210112220"
                                    <button type="button"
                                        onclick="setD4DecodeInput('1020211001000210112220')">
                                    As Input for Decode
                                </button>
                            </li>

                        </ul>

                    </div>
                    <details>
                        <summary style="text-align: center;">I for Current Dimension</summary>
                        <div>${refine_result[8]}</div>
                    </details>
                </div>
                </details>
                `;
            // Now highlight the table cell
            highlightCell(refine_result[5], refine_result[6], refine_result[7]);

            } catch (error) {
                console.error("JavaScript捕获的错误:", error);
                outputDiv.innerHTML = `<div class="error">错误: ${error.message}</div>`;
            }
        }

        async function D3_construct_runEncode() {
            const input = document.getElementById('inputMessage').value;
            const outputDiv = document.getElementById('encodeOutput');
            logLoading(`D3 Encode: '<span style="color:blue;">${input}</span>'`);

            // 新增校验逻辑
            if (!validateInput(input,2)) {
                outputDiv.innerHTML = '<div class="error">Please check the format of your input.</div>';
                return; // 校验失败时终止执行
            }

            outputDiv.innerHTML = "D3 Encoding...";
            
            try {
                const resultProxy  = await pyodide.runPython(`
                    from Web_Final_D3 import main_function
                    correct_code, code_length, efficiency = main_function("${input}")
                    [correct_code, code_length, efficiency]
                `);
                const result = Array.from(resultProxy);
                console.log("Result:", result);

                outputDiv.innerHTML = `
                    Result:<span class="success"> Success!</span>
                    <div>D3 Correct Codeword: 
                        "${result[0]}"
                    <button type="button"
                        onclick="document.getElementById('inputCode').value='${result[0]}';
                                logLoading('As Input for D3 Decode: <span style=&quot;color:blue;&quot;>${result[0]}</span>');">
                        As Input for D3 Decode
                    </button>
                    </div>
                    <div>Length: ${result[1]}</div>
                    <div>Code Rate: ${result[2]}</div>
                `;
            } catch (error) {
                console.error("JavaScript捕获的错误:", error);
                outputDiv.innerHTML = `<div class="error">错误: ${error.message}</div>`;
            }
        }

        async function D3_EC_runDecode() {
            const input = document.getElementById('inputCode').value;
            const outputDiv = document.getElementById('output');
            logLoading(`D3 Decode: '<span style="color:blue;">${input}</span>'`);
            // 新增校验逻辑
            if (!validateInput(input,4)) {
                outputDiv.innerHTML = '<div class="error">Please check the format of your input.</div>';
                return; // 校验失败时终止执行
            }

            outputDiv.innerHTML = "D3 Decoding...";
            
            try {
                const resultProxy  = await pyodide.runPython(`
                    from Web_Final_D3_EC import main_function
                    feature, loc, corrected, announcement, msg = main_function("${input}")
                    [feature, loc, corrected, announcement, msg]
                `);
                const result = Array.from(resultProxy);
                console.log("Result:", result);
                const statusText_d3 = result[3];
                let statusClass = '';

                if (statusText_d3.includes("two or more mistakes")) {
                    statusClass = "error";
                    result[1] = "N/A"
                    result[2] = "N/A"
                } else if (statusText_d3.includes("error is located at")) {
                    statusClass = "warning";
                    result[2] = highlightDifferences(input, result[2])
                } else if (statusText_d3.includes("perfect code")) {
                    statusClass = "success";
                    result[1] = "N/A"
                }

                outputDiv.innerHTML = `
                    <div class="status-message">
                        Status: 
                        <span class="status-content ${statusClass}">${result[3]}</span>
                    </div>

                    <div>Corrected Codeword: 
                        "${result[2]}"
                    </div>
                    <div>Original Message: <strong>"${result[4]}"</strong></div>
                    <div>Index of Erroneous Trit: ${result[1]}</div>
                    <div>P_all: ${result[0]}</div>
                `;

            } catch (error) {
                console.error("JavaScript捕获的错误:", error);
                outputDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        function setD4DecodeInput(value) {
            document.getElementById('d4_inputCode').value = value;
            logLoading(`As D4 Decode Input: '<span style="color:blue;">${value}</span>'`);
        }

        function d4_encoding_generate_Random_Ternary() {
            const inputField = document.getElementById('d4_inputMessage');
            const length = Math.floor(Math.random() * 25) + 9; // 生成3-27的随机长度
            const characters = ['0', '1', '2'];
            let result = '';
            
            for (let i = 0; i < length; i++) {
                result += characters[Math.floor(Math.random() * 3)];
            }
            
            inputField.value = result;
            logLoading(`Ternary message'<span style="color:blue;">${result}</span>' as input for encode d4`);
        }

        function d3_encoding_generate_Random_Ternary() {
            const inputField = document.getElementById('inputMessage');
            const length = Math.floor(Math.random() * 26) + 9; // 生成2-27的随机长度
            const characters = ['0', '1', '2'];
            let result = '';
            
            for (let i = 0; i < length; i++) {
                result += characters[Math.floor(Math.random() * 3)];
            }
            
            inputField.value = result;
            logLoading(`Ternary message'<span style="color:blue;">${result}</span>' as input for encode d3`);
        }

            // 修改后的点击事件处理（使用事件委托）
            document.addEventListener('click', function(e) {    
                // 1. 检测点击目标
                const cell = e.target.closest('.clickable-case');
                const exampleContainer = document.getElementById('caseExample');
                
                if (!cell || !exampleContainer) return;

                // 2. 清除其他单元格的激活状态
                document.querySelectorAll('.clickable-case.active').forEach(activeCell => {
                    activeCell.classList.remove('active');
                });

                // 3. 设置当前单元格激活状态
                cell.classList.add('active');

                // 4. 获取并显示示例代码（支持HTML标签）
                const example = cell.dataset.example || 'No example available';
                exampleContainer.innerHTML = `
                    <div class="sample-display">
                        ${example}
                    </div>
                    <!-- new button -->
                        <button id="useAsInputBtn" type="button" style="margin-left:8px;">
                            As&nbsp;Input&nbsp;for&nbsp;Decode
                        </button>
                `;

                        // 5. 给新插入的按钮绑定事件
            exampleContainer.querySelector('#useAsInputBtn')
                .addEventListener('click', () => {
                    // const input = document.getElementById('d4_inputCode');
                    // 去掉示例中的任何 HTML 标签，只留下纯文本
                    //input.value = example.replace(/<[^>]*>/g, '').trim();
                    const cleanValue = example.replace(/<[^>]*>/g, '').trim();
                    setD4DecodeInput(cleanValue);
                });

            });





        function highlightDifferences(original, revised) {
            let result = '';
            for (let i = 0; i < revised.length; i++) {
                if (original[i] === revised[i]) {
                // Same character: no color
                result += revised[i];
                } else {
                // Different character: wrap in a green <span>
                result += `<span style="color:limegreen;">${revised[i]}</span>`;
                }
            }
            return result;
            }


        // 全局状态控制
        let activePanel = null;

        function toggleQA() {
            const qaPanel = document.getElementById('qaPanel');
            const qaBtn = document.getElementById('qaToggleBtn');
            const defPanel = document.getElementById('definitionPanel');
            const defBtn = document.getElementById('definitionToggleBtn');

            const EngineBtn = document.getElementById('engine-btn');

            // 如果当前点击的是已激活面板，则关闭它
            if (activePanel === 'qa') {
                qaPanel.classList.remove('active');
                qaBtn.innerHTML = 'FAQ ▼';
                activePanel = null;
                return;
            }

            // 关闭另一个面板
            defPanel.classList.remove('active');
            defBtn.innerHTML = 'Definition ▼';

            // 切换当前面板
            qaPanel.classList.add('active');
            qaBtn.innerHTML = 'FAQ ▲';
            activePanel = 'qa';
        }

        function toggleDefinition() {
            const defPanel = document.getElementById('definitionPanel');
            const defBtn = document.getElementById('definitionToggleBtn');
            const qaPanel = document.getElementById('qaPanel');
            const qaBtn = document.getElementById('qaToggleBtn');

            // 如果当前点击的是已激活面板，则关闭它
            if (activePanel === 'definition') {
                defPanel.classList.remove('active');
                defBtn.innerHTML = 'Definition ▼';
                activePanel = null;
                return;
            }

            // 关闭另一个面板
            qaPanel.classList.remove('active');
            qaBtn.innerHTML = 'FAQ ▼';

            // 切换当前面板
            defPanel.classList.add('active');
            defBtn.innerHTML = 'Definition ▲';
            activePanel = 'definition';
        }

        // 初始化状态
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('qaPanel').classList.remove('active');
            document.getElementById('definitionPanel').classList.remove('active');

            const toggleBtn = document.getElementById("toggle-loading-panel-btn");
            const panel = document.getElementById("loading-panel");

            if (toggleBtn && panel) {
                toggleBtn.addEventListener("click", () => {
                panel.classList.toggle("hidden");
                });
            }
        });


        function highlightCell(p1, p2, pAllCase) {
            // 1. Convert them to integers if they're strings
            const P1 = parseInt(p1, 10);
            const P2 = parseInt(p2, 10);
            const colIndex = parseInt(pAllCase, 10);

            // 2. Decide which row based on (P1,P2)
            let row;
            if (P1 === 0 && P2 === 0) {
                row = 1;
            } else if (P1 === 0 && P2 !== 0) {
                row = 2;
            } else if (P1 !== 0 && P2 === 0) {
                row = 3;
            } else {
                row = 4;
            }

            // 3. Decide which column based on pAllCase
            //    0 -> 'A', 1 -> 'B', else -> 'C'
            let col;
            if (colIndex === 0) {
                col = '1';
            } else if (colIndex === 1) {
                col = '2';
            } else {
                col = '3';
            }

            // 4. Build the cell ID: e.g. "cell-r2cB"
            const cellId = `cell-r${row}c${col}`;

            // 5. Remove highlight from any previously highlighted cell
            document.querySelectorAll('.clickable-case.highlighted').forEach((el) => {
                el.classList.remove('highlighted');
            });

            // 6. Add highlight to the target cell (if it exists)
            const targetCell = document.getElementById(cellId);
            if (targetCell) {
                targetCell.classList.add('highlighted');
            }
        }

        // 初始化Pyodide
        initializePyodide();
    </script>
</body>
</html>