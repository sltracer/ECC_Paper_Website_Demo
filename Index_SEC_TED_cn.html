<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>三元纠错码</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <style>
        /* ==================== 全局样式 ==================== */
        body {
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
        font-family: sans-serif;
        line-height: 1.6;
        color: #333;
        }

        /* ==================== 布局样式 ==================== */
        .page-container {
        display: flex;
        align-items: flex-start;
        gap: 20px;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        }

        /* ==================== 标题和文本样式 ==================== */
        .paper-title {
        text-align: center;
        font-size: 2em;
        color: #2c3e50;
        margin: 0 0 20px;
        font-weight: 600;
        letter-spacing: -0.5px;
        }

        .authors {
        text-align: center;
        margin-bottom: 20px;
        font-size: 1.1em;
        color: #7f8c8d;
        }

        .author {
        display: inline-block;
        margin: 0 10px;
        }

        .separator {
        color: #bdc3c7;
        font-weight: 300;
        }

        h1 { font-size: 1.6em; margin-bottom: 20px; }
        h2 { font-size: 1.3em; margin: 1em 0 0.5em; }
        h3 { font-size: 1.1em; margin: 1em 0 0.5em; }
        sub { vertical-align: baseline; font-size: 0.8em; }

        /* ==================== 功能模块样式 ==================== */
        /* 主内容区 */
        .d4-section {
        flex: 1;
        margin: 20px 0;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 6px;
        }

        /* 折叠面板 */
        details.operation-section {
        border: 2px solid #ddd;
        border-radius: 6px;
        padding: 10px;
        margin: 20px 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        details.operation-section summary {
        cursor: pointer;
        padding: 10px 10px 10px 28px;
        list-style: none;
        position: relative;
        }


        details.operation-section summary::before {
                content: "▶";
                position: absolute;
                left: 10px;
                top: 50%;
                transform: translateY(-50%);
                color: #0033ff;
                }

        details.operation-section[open] summary::before {
                content: "▼";
                }    


        /* 编码/解码区块 */
        .encode-section,
        .decode-section {
        margin-top: 20px;
        padding: 15px;
        background: #f8f8f8;
        border-radius: 4px;
        border: 1px solid #eee;
        }

        .input-instructions {
        font-size: 0.9em;
        color: #666;
        margin: 8px 0 16px;
        }

        /* ==================== 表格样式 ==================== */
        .analysis-table {
        margin: 20px 0;
        }

        .analysis-table table {
        border-collapse: collapse;
        width: 100%;
        margin: 15px auto;
        }

        .analysis-table th,
        .analysis-table td {
        border: 1px solid #000;
        padding: 8px;
        text-align: center;
        vertical-align: middle;
        }

        .analysis-table caption {
        font-weight: bold;
        margin-bottom: 10px;
        }

        .clickable-case {
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 80px;
        }

        .clickable-case:hover {
        background-color: rgba(0, 51, 255, 0.08);
        }

        .clickable-case.active {
        background-color: rgba(0, 51, 255, 0.15);
        box-shadow: inset 0 0 0 2px #0033ff;
        }

        /* ==================== 侧边面板样式 ==================== */
        /* 通用面板样式 */
        .qa-panel,
        .definition-panel {
        position: fixed;
        top: 0;
        right: -350px;
        width: 260px;
        height: 100vh;
        background: white;
        box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        transition: right 0.3s ease;
        z-index: 1000;
        padding: 20px;
        overflow-y: auto;
        }

        .qa-panel.active,
        .definition-panel.active {
        right: 0;
        }

        /* 内容区域 */
        .qa-content,
        .definition-content {
        padding-top: 20px;
        }

        .qa-item,
        .definition-item {
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
        }

        .qa-question,
        .definition-term {
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 5px;
        }

        .qa-answer,
        .definition-description {
        color: #7f8c8d;
        font-size: 0.9em;
        line-height: 1.5;
        }

        /* 切换按钮 */
        .qa-toggle,
        .definition-toggle {
        cursor: pointer;
        padding: 6px 12px;
        background: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        transition: all 0.3s;
        }

        .qa-toggle:hover,
        .definition-toggle:hover {
        background: #e0e0e0;
        }

        /* ==================== 数学公式样式 ==================== */
        .latex-style {
        font-family: "Cambria Math", "Latin Modern Math", serif;
        font-size: 1.1em;
        color: #333;
        }

        .frac {
        display: inline-block;
        position: relative;
        text-align: center;
        vertical-align: middle;
        margin: 0 0.2em;
        }

        .numerator {
        display: block;
        padding: 0 0.5em;
        border-bottom: 1px solid;
        }

        .denominator {
        display: block;
        padding: 0 0.5em;
        }

        .latex-var {
        font-style: italic;
        padding-right: 0.3em;
        }

        /* ==================== 状态和提示样式 ==================== */
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }

        .status-message { color: #333; }
        .status-content.error { color: red; }
        .status-content.warning { color: orange; }
        .status-content.success { color: green; }

        .highlight-box {
        display: inline-block;
        padding: 2px 6px;
        border: 2px solid #2c7be5;
        border-radius: 4px;
        margin: 0 2px;
        background: #f8f9fe;
        }

        /* ==================== 页脚样式 ==================== */
        .site-footer {
        margin-top: 50px;
        padding: 30px 0;
        border-top: 1px solid #eaeaea;
        background-color: #f9f9f9;
        }

        .footer-links {
        max-width: 800px;
        margin: 0 auto;
        text-align: center;
        display: flex;
        justify-content: center;
        gap: 30px;
        }

        .footer-links a {
        color: #2c3e50;
        text-decoration: none;
        font-size: 0.95em;
        transition: color 0.3s ease;
        }

        .footer-links a:hover {
        color: #3498db;
        text-decoration: underline;
        }

        /* ==================== 响应式设计 ==================== */
        @media (max-width: 600px) {
        .page-container {
            flex-direction: column;
        }
        
        .footer-links {
            flex-direction: column;
            gap: 15px;
        }
        
        .qa-panel,
        .definition-panel {
            width: 80%;
            right: -100%;
        }
        }

        /* Light red background for highlighting */
        .clickable-case.highlighted {
        background-color: #fdd;
        }


        .paper-header {
            text-align: center; /* 整体内容居中 */
        }

        .authors-container {
            position: relative; /* 为绝对定位按钮提供参考 */
            display: flex;
            justify-content: center; /* 作者信息居中 */
            margin-top: 10px; /* 根据实际需要调整与标题的间距 */
        }

        .title-wrapper {
            position: relative;
            text-align: center;      /* 标题居中 */
            }

        .paper-title {
        margin: 0;
        }

        .language-link {
        position: absolute;
        top: 0;
        right: 0;
        }

        .language-btn {
        padding: 6px 12px;
        font-size: 16px;
        background: #f4f4f4;
        border: 2px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
        }


    </style>
</head>
<body>
    <!-- ==================== 论文标题和作者 ==================== -->
    <div class="paper-header">
        <div class="title-wrapper">
          <h1 class="paper-title">三元纠错码</h1>
          <a href="index_SEC_TED_en.html" class="language-link">
            <button class="language-btn">语言：中文</button>
          </a>
        </div>
      </div>
        <div class="authors-container"> <!-- 新增容器包裹作者和按钮 -->
            <div class="authors">
                <span class="author">胡佳旭</span>
                <span class="separator">·</span>
                <span class="author">Kenneth J. Roche</span>
            </div>
        </div>
    <!-- ==================== D4 固定面板 ==================== -->
    <div class="d4-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; gap: 10px;">
            <h1 style="flex-grow: 1;">单纠错三检测码(最小距离4)</h1>
            <div style="display: flex; gap: 5px;">
                <button id="definitionToggleBtn" class="definition-toggle" onclick="toggleDefinition()">定义 ▼</button>
                <button id="qaToggleBtn" class="qa-toggle" onclick="toggleQA()">常见问题 ▼</button>
            </div>
        </div>
        <div>
            该版本可以在码字中<strong>存在且仅存在一位</strong>错误时，准确定位并<strong>纠正</strong>该错误（SEC）；当码字中错误数量<strong>不超过三位</strong>时，可确保<strong>检测</strong>到错误存在（TED）。
            更详细的介绍请见
            <a href="#" onclick="toggleQA(); return false;">常见问题</a> 
            和<a href="https://placeholderhere" target="_blank" rel="noopener noreferrer">论文</a>的<strong>4.2节</strong>。
        </div>        

        <!-- 编码部分 -->
        <div class="encode-section">
            <h2>编译 D4</h2>
            <div class="input-instructions">
                示例： "02110010221011221"  
                <button onclick="d4_encoding_generate_Random_Ternary()" style="margin-left: 10px;">生成随机信息</button>
            </div>
            <div><strong>三进制信息</strong></div>
            <input type="text" id="d4_inputMessage" placeholder="长度至少为3位" style="flex-grow: 1;">
            <button onclick="D4_construct_runEncode()">编译</button>
            <button onclick="document.getElementById('d4_inputMessage').value = ''">清除</button>


            <div id="d4_encode_Output"></div>
        </div>

        <!-- 解码部分 -->
        <div class="decode-section">
            <h2>解译 D4</h2>
            <div class="input-instructions">
                示例： "2020211001022210112220"
            </div>
            <div><strong>D4 纠错码</strong></div>
            <input type="text" id="d4_inputCode" placeholder="长度至少为8位">
            <button onclick="D4_EC_runDecode()">解译</button>
            <button onclick="document.getElementById('d4_inputCode').value = ''">清除</button>
            <div id="d4_decode_output"></div>
        </div>


        <div id="qaPanel" class="qa-panel">
            <div id="qaContent" class="qa-content">
                <h3 style="display: flex; justify-content: space-between; align-items: center;">
                    <span>常见问题</span>
                    <button class="close-btn" onclick="toggleQA()">X</button>
                  </h3>

                <div class="qa-item">
                    <div class="qa-question">Q1: 如何进行编译?</div>
                    <div class="qa-answer">A1: 输入任意至少三位的三进制信息后点击"编译"即可生成纠错码</div>
                </div>
                <div class="qa-item">
                    <div class="qa-question">Q2: 如何进行解译？它的作用是？</div>
                    <div class="qa-answer">
                        A1: 输入任何包含少许错误位的<strong style="color: black;">纠错码</strong> (从编译部分生成)后点击"解译"：
                        <ul style="margin-top: 8px; margin-bottom: 8px; padding-left: 20px;">
                          <li><strong>0位错误：</strong> 检测为有效码字，并还原信息。</li>
                          <li><strong>1位错误：</strong> 将这一位错误纠正，并还原信息。</li>
                          <li><strong>2位错误：</strong> 检测出仅有两位错误，但无法纠正。</li>
                          <li><strong>3位错误：</strong> 检测出错误存在，但会错误的当作单错误情况纠正。</li>
                          <li><strong>4+位错误：</strong> 超出本编码的纠错检测范围。</li>
                        </ul>
                        该版本可以<strong>纠正一位错误</strong>或<strong>检测三位错误</strong>。
                      </div>                
                </div>

                <!-- 更多Q&A项... -->
            </div>
        </div>

        <div id="definitionPanel" class="definition-panel">
            <div id="definitionContent" class="definition-content">
                <h3 style="display: flex; justify-content: space-between; align-items: center;">
                    <span>关键定义</span>
                    <button class="close-btn" onclick="toggleDefinition()">X</button>
                  </h3>

                <!-- 定义1：Error Correction Code -->
                <div class="definition-item">
                    <div class="definition-term"><strong>纠错码</strong></div>
                    <div class="definition-description">
                        一种纠错技术，通过在信息中添加“冗余数据”作为代价，使接受方可以检测或纠正传输或储存过程中产生的错误。
                    </div>
                </div>
        
                <!-- 定义2：Efficiency -->
                <div class="definition-item">
                    <div class="definition-term"><strong>码率</strong></div>
                    <div class="definition-description">
                        码率是原信息位数与编译后总位数的比率:<br>
                        <div class="latex-style">
                            <span class="latex-var">码率</span> = 
                            <span class="frac">
                              <span class="numerator">原信息位数</span>
                              <span class="denominator">编译后总位数</span>
                            </span>
                          </div>
                        码率越高意味着冗余越少，信息传输效率更高。
                    </div>
                </div>
        
                <!-- 定义3：Hamming Distances -->
                <div class="definition-item">
                    <div class="definition-term"><strong>最小汉明距离</strong></div>
                    <div class="definition-description">
                        纠错码的最小汉明距离或最小距离表示从一个有效码字变为另一个相同长度的有效码字最少需要改变的位数。<br>
                        <strong>D3:</strong> 最小距离等于3 (SEC-DED, 单纠错双检测码)<br>
                        <strong>D4:</strong> 最小距离等于4 (SEC-TED, 单纠错三检测码)
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- ==================== D3 折叠面板 ==================== -->
    <details class="operation-section">
        <summary><h1>单纠错双检测码(更高的码率)</h1></summary>
        <div>
            
            <div>
                该版本可以在码字中<strong>存在且仅存在一位</strong>错误时，准确定位并<strong>纠正</strong>该错误（SEC）；当码字中错误数量<strong>不超过两位</strong>时，可确保<strong>检测</strong>到错误存在（DED）。 更详细的介绍请见<a href="https://placeholderhere" target="_blank" rel="noopener noreferrer">论文</a>的<strong>4.1节</strong>。
            </div>        
        <!-- 编码部分 -->
        <div class="encode-section">
            <h2>编译 D3</h2>
            <div class="input-instructions">
                示例： "2100212002202121021010202201111101121"
                <button onclick="d3_encoding_generate_Random_Ternary()" style="margin-left: 10px;">生成随机信息</button>
            </div>
            <div><strong>三进制信息</strong></div>
            <input type="text" id="inputMessage" placeholder="长度至少为2位">
            <button onclick="D3_construct_runEncode()">编译</button>
            <button onclick="document.getElementById('inputMessage').value = ''">清除</button>
            <div id="encodeOutput"></div>
        </div>

        <!-- 解码部分 -->
        <div class="decode-section">
            <h2>解译 D3</h2>
            <div class="input-instructions">
                示例： "222100021200202021210210102022011111011221"
            </div>
            <div><strong>D3 纠错码</strong></div>
            <input type="text" id="inputCode" placeholder="长度至少为4位">
            <button onclick="D3_EC_runDecode()">解译</button>
            <button onclick="document.getElementById('inputCode').value = ''">清除</button>
            <div id="output"></div>
        </div>
    </details>

    <footer class="site-footer">
        <div class="footer-links">
            <a href="Jiaxu_Hu_Resume_April_1st.pdf" target="_blank" rel="noopener">作者简历</a>
            <a href="https://github.com/justaplaceholderhere" target="_blank" rel="noopener">GitHub</a>
            <a href="https://faculty.washington.edu/k8r/" target="_blank" rel="noopener">作者网页</a>
        </div>
    </footer>


    <script>
        let pyodide;
        async function initializePyodide() {
            pyodide = await loadPyodide({
                indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/"
            });
            
            // 0. 显式加载numpy包
            await pyodide.loadPackage("numpy");  // 确保使用await等待加载完成

            // 1. 创建虚拟文件系统
            await pyodide.FS.mkdir('/mypkg');
            await pyodide.FS.mount(pyodide.FS.filesystems.IDBFS, { root: '.' }, '/mypkg');

            // 2. 动态加载Python文件并写入虚拟目录
            const files = ['Module.py', 'Web_Final_D3.py', 'Web_Final_D3_EC.py', 'Web_Final_D4.py', 'Web_Final_D4_EC.py'];
            for (const file of files) {
                const response = await fetch(file);
                const content = await response.text();
                pyodide.FS.writeFile(`/mypkg/${file}`, content, { encoding: 'utf8' });
            }

            // 3. 添加路径并导入模块
            await pyodide.runPython(`
                import sys
                sys.path.append('/mypkg')
                from Web_Final_D3_EC import main_function
            `);
        }
        
        function validateInput(input,minlength) {
            // 检查输入长度
            if (input.length < minlength) {
                alert(`至少${minlength}位，当前为 ${input.length} 位。`);
                return false;
            }
            // 使用正则表达式校验合法性
            if (!/^[012]+$/.test(input)) {
                alert("请输入三进制信息！");
                return false;
            }
            return true;
        }

        async function D4_construct_runEncode() {
            const input = document.getElementById('d4_inputMessage').value;
            const outputDiv = document.getElementById('d4_encode_Output');

            // 新增校验逻辑
            if (!validateInput(input,3)) {
                outputDiv.innerHTML = '<div class="error">请检查您输入的信息格式。</div>';
                return; // 校验失败时终止执行
            }

            outputDiv.innerHTML = "D4 Encoding...";
            
            try {
                const resultProxy  = await pyodide.runPython(`
                    from Web_Final_D4 import main_function
                    correct_code, code_length, efficiency = main_function("${input}")
                    [correct_code, code_length, efficiency]
                `);
                const result = Array.from(resultProxy);

                outputDiv.innerHTML = `
                    状态：<span class="success">成功</span>
                    <div>
                        D4 纠错码: "<span>${result[0]}</span>"
                        <button type="button"
                                onclick="document.getElementById('d4_inputCode').value='${result[0]}'">
                            填入解译栏
                        </button>
                    </div>
                    <div>总位数: ${result[1]}</div>
                    <div>码率: ${result[2]}</div>
                `;
            } catch (error) {
                console.error("JavaScript捕获的错误:", error);
                outputDiv.innerHTML = `<div class="error">错误: ${error.message}</div>`;
            }
        }

        async function D4_EC_runDecode() {

            // 在解码开始前获取当前折叠状态
            const errorCaseDetails = document.getElementById('ErrorCaseAnalysis');
            const wasOpen = errorCaseDetails ? errorCaseDetails.open : false;

            const input = document.getElementById('d4_inputCode').value;
            const outputDiv = document.getElementById('d4_decode_output');

            if (!validateInput(input, 8)) {
                outputDiv.innerHTML = '<div class="error">请检查您输入的信息格式。</div>';
                return;
            }

            outputDiv.innerHTML = "D4 Decoding...";

            try {
                const resultProxy  = await pyodide.runPython(`
                    from Web_Final_D4_EC import main_function
                    correct_code, pure_message, error_location, announcement, P_all, P_1, P_2, P_all_case, I = main_function("${input}")
                    [correct_code, pure_message, error_location, announcement, P_all, P_1, P_2, P_all_case, I]
                `);
                const result = Array.from(resultProxy);
                let statusText = result[3];
                const refine_result = [...result];
                let statusClass = '';

                if (statusText.includes("two or more mistakes")) {
                    statusClass = "error";
                    refine_result[0] = 'N/A';
                    refine_result[1] = 'N/A';
                    refine_result[2] = 'N/A';
                    statusText = "检测到两位或更多错误。"

                } else if (statusText.includes("O as second last digit, E as last digit")) {
                    statusClass = "warning";
                    refine_result[0] = highlightDifferences(input, result[0]);

                    const match = statusText.match(/at the (E|O) position.*change of ([+-]{1,2}\d+)/); 
                    if (match) {
                        const pos = match[1] === "E" ? "E(末位)" : "O(倒数第二位)";
                        const delta = match[2];
                        statusText = `错误出现在${pos}，数值变动为 ${delta}。`;
                    } else {
                        statusText = "检测到特殊错误位置，但解析失败。"; //呃呃，这真用不上吧。
                    }
                } else if (statusText.includes("error is located at")) {
                    statusClass = "warning";
                    refine_result[0] = highlightDifferences(input, result[0])

                    const match = statusText.match(/at the (\d+)(?:st|nd|rd|th) position.*change of ([+-]?\d+)/);
                    const pos = match[1];   // 位置数字，例如 "1"
                    const delta = match[2]; // 改变量，例如 "+1" 或 "-2"
                    statusText = `错误出现在第${pos}位，数值变动为 ${delta}。`;

                } else if (statusText.includes("perfect code")) {
                    statusClass = "success";
                    refine_result[2] = 'N/A';
                    statusText = "完美，没有任何错误！"
                }

                outputDiv.innerHTML = `
                    <div class="status-message">
                        状态: <span class="status-content ${statusClass}">${statusText}</span>
                    </div>
                    <div>原有效码字: "${refine_result[0]}"</div>
                    <div>原信息: "${refine_result[1]}"</div>

                <details id="ErrorCaseAnalysis" ${wasOpen ? 'open' : ''}>
                <summary>细节信息</summary>

                <div>错误位索引: ${refine_result[2]}</div>
                <div>P_all: ${refine_result[4]}</div>
                <div>P_1: ${refine_result[5]}</div>
                <div>P_2: ${refine_result[6]}</div>

                <div class="analysis-table" style="margin-top: 10px;">
                    <table class="interactive-table" style="border-collapse: collapse; margin: 1em auto;">
                    <caption>错误分布分析</caption>
                    <thead>
                        <tr>
                        <th style="border: 1px solid #000; padding: 6px;"></th>
                        <th style="border: 1px solid #000; padding: 6px;">A: P<sub>all</sub>=0</th>
                        <th style="border: 1px solid #000; padding: 6px;">B: P<sub>all</sub> ∈ I ∨ 2P<sub>all</sub> ∈ I</th>
                        <th style="border: 1px solid #000; padding: 6px;">C: P<sub>all</sub>,2P<sub>all</sub> ∉ I ∪ {0}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Row 1 -->
                        <tr>
                        <td style="border: 1px solid #000; padding: 6px;">
                            1: P<sub>1</sub>=0, P<sub>2</sub>=0
                        </td>
                        <td id="cell-r1c1" class="clickable-case"
                            data-example="2020211001022210112220"
                            style="border: 1px solid #000; padding: 6px;">
                            完美
                        </td>
                        <td id="cell-r1c2" class="clickable-case"

                            data-example="2<span style='color:red;'>2</span>2021100102221011222<span style='color:red;'>1</span>"
                            style="border: 1px solid #000; padding: 6px;">
                            2 位错误
                        </td>
                        <!-- C: separate cell for row 1 -->
                        <td id="cell-r1c3" class="clickable-case" 

                            data-example="<span style='color:red;'>1</span>0<span style='color:red;'>0</span>0211001022210112220"
                            style="border: 1px solid #000; padding: 6px;">
                            2 位错误
                        </td>
                        </tr>
                        
                        <!-- Row 2 -->
                        <tr>
                        <td style="border: 1px solid #000; padding: 6px;">
                            2: P<sub>1</sub>=0, P<sub>2</sub>≠0
                        </td>
                        <td id="cell-r2c1" class="clickable-case"
                            data-example="202021100102221011222<span style='color:red;'>1</span>"
                            style="border: 1px solid #000; padding: 6px;">
                            X<sub>Ē</sub> = X<sub>E</sub> - P<sub>2</sub>
                        </td>
                        <td id="cell-r2c2"  class="clickable-case"
                            data-example="2<span style='color:red;'>1</span>20211001022210112220"
                            style="border: 1px solid #000; padding: 6px;">
                            复合情况 1
                        </td>
                        <!-- C: separate cell for row 2 -->
                        <td id="cell-r2c3" class="clickable-case"
                            data-example="2<span style='color:red;'>1</span>202<span style='color:red;'>2</span>1001022210112220"
                            style="border: 1px solid #000; padding: 6px;">
                            2 位错误
                        </td>
                        </tr>
                        
                        <!-- Row 3 -->
                        <tr>
                        <td style="border: 1px solid #000; padding: 6px;">
                            3: P<sub>1</sub>≠0, P<sub>2</sub>=0
                        </td>
                        <td id="cell-r3c1" class="clickable-case"
                            data-example="20202110010222101122<span style='color:red;'>1</span>0"
                            style="border: 1px solid #000; padding: 6px;">
                            X<sub>Ō</sub> = X<sub>O</sub> - P<sub>1</sub>
                        </td>
                        <td id="cell-r3c2" class="clickable-case"
                            data-example="<span style='color:red;'>1</span>020211001022210112220"
                            style="border: 1px solid #000; padding: 6px;">
                            复合情况 2
                        </td>
                        <!-- C: separate cell for row 3 -->
                        <td id="cell-r3c3" class="clickable-case"
                            data-example="<span style='color:red;'>1</span>0<span style='color:red;'>1</span>0211001022210112220"
                            style="border: 1px solid #000; padding: 6px;">
                            2 位错误
                        </td>
                        </tr>
                        
                        <!-- Row 4 -->
                        <tr>
                        <td style="border: 1px solid #000; padding: 6px;">
                            4: P<sub>1</sub>≠0, P<sub>2</sub>≠0
                        </td>
                        <td id="cell-r4c1" class="clickable-case"
                            data-example="<span style='color:red;'>01</span>20211001022210112220"
                            style="border: 1px solid #000; padding: 6px;">
                            2 位错误
                        </td>
                        <td id="cell-r4c2" class="clickable-case"
                            data-example="<span style='color:red;'>02</span>20211001022210112220"
                            style="border: 1px solid #000; padding: 6px;">
                            2 位错误
                        </td>
                        <!-- C: separate cell for row 4 -->
                        <td id="cell-r4c3" class="clickable-case"
                            data-example="2<span style='color:red;'>10</span>0211001022210112220"
                            style="border: 1px solid #000; padding: 6px;">
                            2 位错误
                        </td>
                        </tr>
                    </tbody>
                    </table>

                <!-- 修改表格下方显示容器 -->
                <div id="caseExample" class="example-container" style="margin-top:10px; text-align:center; font-weight:bold;">
                    <span class="placeholder-text">点击任意一个情况以获取示例。</span>
                </div>

                    <!-- Case 1 and Case 2 explanations -->
                    <div class="case-explanations" style="margin-top: 20px; padding: 15px; border-top: 2px solid #eee;">

                    <h4>情况分析</h4>
                        <p><strong>复合情况 1：</strong>设 <em>f</em> = P<sub>2</sub> · P<sub>all</sub></p>
                        <ul style="list-style-type: circle; padding-left: 20px;">

                            <li>
                                若 <em>f</em> ∈ I<sub>2</sub>，则表示单个错误位于 <em>f</em>，且该位置原本值为：X̄<sub>f</sub> = (X<sub>f</sub> - P<sub>2</sub>) mod 3。点击表格获取示例。
                            </li>

                            <li>
                                若 <em>f</em> ∉ I<sub>2</sub>，则表示存在至少三位错误。
                                示例："<b>2<span style='color:red;'>2</span>202110010222101<span style='color:red;'>20</span>220</b>" 
                                <button type="button"
                                        onclick="document.getElementById('d4_inputCode').value='2220211001022210120220'">
                                    填入解译栏
                                </button>
                            </li>

                        </ul>

                        <p><strong>复合情况 2:</strong> 设 <em>f</em> = P<sub>1</sub> · P<sub>all</sub></p>
                            <ul style="list-style-type: circle; padding-left: 20px;">

                                <li>
                                    若 <em>f</em> ∈ I<sub>1</sub>，则表示单个错误位于 <em>f</em>，且该位置原本值为：X̄<sub>f</sub> = (X<sub>f</sub> - P<sub>1</sub>) mod 3。点击表格获取示例。
                                </li>

                                <li>
                                    若<em>f</em> ∉ I<sub>1</sub>，则表示存在至少三位错误。
                                    示例："<b><span style='color:red;'>1</span>0202110010<span style='color:red;'>00</span>210112220</b>"
                                    <button type="button"
                                        onclick="document.getElementById('d4_inputCode').value='1020211001000210112220'">
                                    填入解译栏
                                </button>
                                </li>
                            </ul>
                        
                    </div>

                    <details>
                        <summary style="text-align: center;">集合 I (选中索引)</summary>
                        <div>${refine_result[8]}</div>
                    </details>
                </div>
                </details>
                `;
            // Now highlight the table cell
            highlightCell(refine_result[5], refine_result[6], refine_result[7]);

            } catch (error) {
                console.error("JavaScript捕获的错误:", error);
                outputDiv.innerHTML = `<div class="error">错误: ${error.message}</div>`;
            }
        }

        async function D3_construct_runEncode() {
            const input = document.getElementById('inputMessage').value;
            const outputDiv = document.getElementById('encodeOutput');

            // 新增校验逻辑
            if (!validateInput(input,2)) {
                outputDiv.innerHTML = '<div class="error">请检查您输入的信息格式。</div>';
                return; // 校验失败时终止执行
            }

            outputDiv.innerHTML = "D3 Encoding...";
            
            try {
                const resultProxy  = await pyodide.runPython(`
                    from Web_Final_D3 import main_function
                    correct_code, code_length, efficiency = main_function("${input}")
                    [correct_code, code_length, efficiency]
                `);
                const result = Array.from(resultProxy);
                console.log("Result:", result);

                outputDiv.innerHTML = `
                    状态：<span class="success">成功</span>
                    <div>D3 纠错码: 
                        "${result[0]}"
                        <button type="button"
                        onclick="document.getElementById('inputCode').value='${result[0]}'">
                            填入D3解译栏
                        </button>
                    </div>
                    <div>总位数: ${result[1]}</div>
                    <div>码率: ${result[2]}</div>
                `;
            } catch (error) {
                console.error("JavaScript捕获的错误:", error);
                outputDiv.innerHTML = `<div class="error">错误: ${error.message}</div>`;
            }
        }

        async function D3_EC_runDecode() {
            const input = document.getElementById('inputCode').value;
            const outputDiv = document.getElementById('output');

            // 新增校验逻辑
            if (!validateInput(input,4)) {
                outputDiv.innerHTML = '<div class="error">请检查您输入的信息格式。</div>';
                return; // 校验失败时终止执行
            }

            outputDiv.innerHTML = "D3 Decoding...";
            
            try {
                const resultProxy  = await pyodide.runPython(`
                    from Web_Final_D3_EC import main_function
                    feature, loc, corrected, announcement, msg = main_function("${input}")
                    [feature, loc, corrected, announcement, msg]
                `);
                const result = Array.from(resultProxy);
                console.log("Result:", result);
                let statusText_d3 = result[3];
                let statusClass = '';

                if (statusText_d3.toLowerCase().includes("two or more mistakes")) {
                    statusClass = "error";
                    result[1] = "N/A"
                    result[2] = "N/A"
                    statusText_d3 = "检测到两位或更多错误。"
                } else if (statusText_d3.includes("error is located at")) {
                    statusClass = "warning";
                    result[2] = highlightDifferences(input, result[2])
                    const match = statusText_d3.match(/at the (\d+)(?:st|nd|rd|th) position.*change of ([+-]?\d+)/);
                    const pos = match[1];   // 位置数字，例如 "1"
                    const delta = match[2]; // 改变量，例如 "+1" 或 "-2"
                    statusText_d3 = `错误出现在第${pos}位，数值变动为 ${delta}。`;

                } else if (statusText_d3.includes("perfect code")) {
                    statusClass = "success";
                    statusText_d3 = "完美，没有任何错误！"
                    result[1] = "N/A"
                }

                outputDiv.innerHTML = `
                    <div class="status-message">
                        Status: 
                        <span class="status-content ${statusClass}">${statusText_d3}</span>
                    </div>

                    <div>
                        原有效码字: "${result[2]}"
                    </div>
                    <div>原信息: <strong>"${result[4]}"</strong></div>
                    <div>错误位索引: ${result[1]}</div>
                    <div>P_all: ${result[0]}</div>

                `;

            } catch (error) {
                console.error("JavaScript捕获的错误:", error);
                outputDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        function d4_encoding_generate_Random_Ternary() {
            const inputField = document.getElementById('d4_inputMessage');
            const length = Math.floor(Math.random() * 25) + 9; // 生成3-27的随机长度
            const characters = ['0', '1', '2'];
            let result = '';
            
            for (let i = 0; i < length; i++) {
                result += characters[Math.floor(Math.random() * 3)];
            }
            
            inputField.value = result;
        }

        function d3_encoding_generate_Random_Ternary() {
            const inputField = document.getElementById('inputMessage');
            const length = Math.floor(Math.random() * 26) + 9; // 生成2-27的随机长度
            const characters = ['0', '1', '2'];
            let result = '';
            
            for (let i = 0; i < length; i++) {
                result += characters[Math.floor(Math.random() * 3)];
            }
            
            inputField.value = result;
        }

        // 修改后的点击事件处理（使用事件委托）
        document.addEventListener('click', function(e) {
            // 1. 检测点击目标
            const cell = e.target.closest('.clickable-case');
            const exampleContainer = document.getElementById('caseExample');
            
            if (!cell || !exampleContainer) return;

            // 2. 清除其他单元格的激活状态
            document.querySelectorAll('.clickable-case.active').forEach(activeCell => {
                activeCell.classList.remove('active');
            });

            // 3. 设置当前单元格激活状态
            cell.classList.add('active');

            // 4. 获取并显示示例代码（支持HTML标签）
            const example = cell.dataset.example || 'No example available';
            exampleContainer.innerHTML = `
                <div class="sample-display">
                    ${example}
                </div>
                <!-- new button -->
                    <button id="useAsInputBtn" type="button" style="margin-left:8px;">
                        填入解译栏
                    </button>
            `;

                    // 5. 给新插入的按钮绑定事件
        exampleContainer.querySelector('#useAsInputBtn')
            .addEventListener('click', () => {
                const input = document.getElementById('d4_inputCode');
                // 去掉示例中的任何 HTML 标签，只留下纯文本
                input.value = example.replace(/<[^>]*>/g, '').trim();
            });

        });

        function highlightDifferences(original, revised) {
            let result = '';
            for (let i = 0; i < revised.length; i++) {
                if (original[i] === revised[i]) {
                // Same character: no color
                result += revised[i];
                } else {
                // Different character: wrap in a green <span>
                result += `<span style="color:limegreen;">${revised[i]}</span>`;
                }
            }
            return result;
            }


        // 全局状态控制
        let activePanel = null;

        function toggleQA() {
            const qaPanel = document.getElementById('qaPanel');
            const qaBtn = document.getElementById('qaToggleBtn');
            const defPanel = document.getElementById('definitionPanel');
            const defBtn = document.getElementById('definitionToggleBtn');

            // 如果当前点击的是已激活面板，则关闭它
            if (activePanel === 'qa') {
                qaPanel.classList.remove('active');
                qaBtn.innerHTML = '常见问题 ▼';
                activePanel = null;
                return;
            }

            // 关闭另一个面板
            defPanel.classList.remove('active');
            defBtn.innerHTML = '定义 ▼';

            // 切换当前面板
            qaPanel.classList.add('active');
            qaBtn.innerHTML = '常见问题 ▲';
            activePanel = 'qa';
        }

        function toggleDefinition() {
            const defPanel = document.getElementById('definitionPanel');
            const defBtn = document.getElementById('definitionToggleBtn');
            const qaPanel = document.getElementById('qaPanel');
            const qaBtn = document.getElementById('qaToggleBtn');

            // 如果当前点击的是已激活面板，则关闭它
            if (activePanel === 'definition') {
                defPanel.classList.remove('active');
                defBtn.innerHTML = '定义 ▼';
                activePanel = null;
                return;
            }

            // 关闭另一个面板
            qaPanel.classList.remove('active');
            qaBtn.innerHTML = '常见问题 ▼';

            // 切换当前面板
            defPanel.classList.add('active');
            defBtn.innerHTML = '定义 ▲';
            activePanel = 'definition';
        }

        // 初始化状态
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('qaPanel').classList.remove('active');
            document.getElementById('definitionPanel').classList.remove('active');
        });


        function highlightCell(p1, p2, pAllCase) {
            // 1. Convert them to integers if they're strings
            const P1 = parseInt(p1, 10);
            const P2 = parseInt(p2, 10);
            const colIndex = parseInt(pAllCase, 10);

            // 2. Decide which row based on (P1,P2)
            let row;
            if (P1 === 0 && P2 === 0) {
                row = 1;
            } else if (P1 === 0 && P2 !== 0) {
                row = 2;
            } else if (P1 !== 0 && P2 === 0) {
                row = 3;
            } else {
                row = 4;
            }

            // 3. Decide which column based on pAllCase
            //    0 -> 'A', 1 -> 'B', else -> 'C'
            let col;
            if (colIndex === 0) {
                col = '1';
            } else if (colIndex === 1) {
                col = '2';
            } else {
                col = '3';
            }

            // 4. Build the cell ID: e.g. "cell-r2cB"
            const cellId = `cell-r${row}c${col}`;

            // 5. Remove highlight from any previously highlighted cell
            document.querySelectorAll('.clickable-case.highlighted').forEach((el) => {
                el.classList.remove('highlighted');
            });

            // 6. Add highlight to the target cell (if it exists)
            const targetCell = document.getElementById(cellId);
            if (targetCell) {
                targetCell.classList.add('highlighted');
            }
        }

        // 初始化Pyodide
        initializePyodide();
    </script>
</body>
</html>